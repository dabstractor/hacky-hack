# Product Requirement Prompt (PRP)

**Work Item**: P2.M2.T2.S1 - Create PRP Document Zod Schema

**Date**: 2026-01-12

---

## Goal

**Feature Goal**: Create Zod schemas for PRPDocument and its related interfaces (ValidationGate, SuccessCriterion) to enable runtime validation of PRP structures generated by the Researcher Agent in the Groundswell workflow.

**Deliverable**: Three Zod schemas exported from `src/core/models.ts`:

- `ValidationGateSchema` - validates 4-level validation gate structure
- `SuccessCriterionSchema` - validates success criterion checkbox structure
- `PRPDocumentSchema` - validates complete PRP document structure

**Success Definition**:

- All three schemas compile without TypeScript errors
- Schemas match their corresponding TypeScript interfaces exactly
- Zod validation correctly accepts valid PRP data and rejects invalid data
- Unit tests pass covering happy paths, edge cases, and error scenarios

## Why

- **Type Safety at Runtime**: The PRPDocument interface provides compile-time type safety, but Zod schemas add runtime validation for data coming from LLM outputs (Architect Agent, Researcher Agent)
- **Groundswell Integration**: P2.M2.T2.S2 (Create PRP generation prompt) will use `PRPDocumentSchema` with Groundswell's `responseFormat` to ensure structured LLM outputs match the PRP structure
- **Data Integrity**: Prevents malformed PRPs from breaking downstream components (PRP Generator, PRP Executor in P3.M3.T1)
- **Consistency**: Follows existing pattern established in P1.M2.T1.S2 where Zod schemas were created for Backlog, Phase, Milestone, Task, and Subtask interfaces

## What

Create Zod schemas that validate the PRPDocument structure and its nested types:

### ValidationGateSchema

```typescript
z.object({
  level: z.union([z.literal(1), z.literal(2), z.literal(3), z.literal(4)]),
  description: z.string(),
  command: z.union([z.string(), z.null()]),
  manual: z.boolean(),
});
```

### SuccessCriterionSchema

```typescript
z.object({
  description: z.string(),
  satisfied: z.boolean(),
});
```

### PRPDocumentSchema

```typescript
z.object({
  taskId: z.string(),
  objective: z.string(),
  context: z.string(),
  implementationSteps: z.array(z.string()),
  validationGates: z.array(ValidationGateSchema),
  successCriteria: z.array(SuccessCriterionSchema),
  references: z.array(z.string()),
});
```

### Success Criteria

- [ ] `ValidationGateSchema` validates level as literal 1-4, description as string, command as string|null, manual as boolean
- [ ] `SuccessCriterionSchema` validates description as string, satisfied as boolean
- [ ] `PRPDocumentSchema` validates all 7 properties with correct types
- [ ] All schemas export properly from `src/core/models.ts`
- [ ] Unit tests pass for all three schemas

---

## All Needed Context

### Context Completeness Check

_The implementing agent knows nothing about this codebase. This PRP provides all necessary context for one-pass implementation success._

### Documentation & References

```yaml
# MUST READ - Core interfaces to replicate as Zod schemas
- file: src/core/models.ts
  lines: 918-962
  why: ValidationGate interface definition - exact structure to replicate in Zod
  pattern: Note the level type is `1 | 2 | 3 | 4` (literal union), not just number
  gotcha: Must use z.literal() for each level value, not z.number().min(1).max(4)

- file: src/core/models.ts
  lines: 1018-1040
  why: SuccessCriterion interface definition - simple structure with description and satisfied
  pattern: Readonly properties in interface, but Zod doesn't enforce readonly

- file: src/core/models.ts
  lines: 1114-1187
  why: PRPDocument interface definition - complete structure with all 7 properties
  pattern: All properties are readonly strings or arrays

# MUST READ - Existing Zod schema patterns to follow
- file: src/core/models.ts
  lines: 985-990
  why: EXISTING ValidationGateSchema already exists - this is a REFERENCE/UPDATE task, not new creation
  pattern: Current implementation uses `z.union([z.literal(1), z.literal(2), z.literal(3), z.literal(4)])`
  gotcha: The schema already exists! Verify it matches the interface correctly

- file: src/core/models.ts
  lines: 1060-1063
  why: EXISTING SuccessCriterionSchema already exists - verify it matches interface
  pattern: Simple z.object() with string and boolean

- file: src/core/models.ts
  lines: 1213-1223
  why: EXISTING PRPDocumentSchema already exists - verify it matches interface
  pattern: Uses z.array() for implementationSteps, validationGates, successCriteria, references

- file: src/core/models.ts
  lines: 78-85
  why: StatusEnum pattern - shows z.enum() usage for string unions
  pattern: `z.enum(['Planned', 'Researching', ...])` creates enum schema

- file: src/core/models.ts
  lines: 237-253
  why: SubtaskSchema pattern - shows z.ZodType<Interface> annotation
  pattern: `export const SubtaskSchema: z.ZodType<Subtask> = z.object({...})`
  gotcha: Always use `z.ZodType<InterfaceName>` type annotation for proper inference

- file: src/core/models.ts
  lines: 440-454
  why: MilestoneSchema pattern - shows recursive structure with z.lazy()
  pattern: `z.lazy(() => z.object({...}))` for self-referencing schemas

# MUST READ - Test patterns to follow
- file: tests/unit/core/models.test.ts
  why: Existing Zod schema test patterns - copy this structure for new tests
  pattern: safeParse() for validation, expect(result.success).toBe(true/false)
  gotcha: Tests use describe blocks grouped by schema, reusable fixtures with `valid` prefix

- file: tests/unit/core/models.test.ts
  lines: 1-50
  why: Import pattern - shows how to import both types and schemas
  pattern: `import { ValidationGateSchema, type ValidationGate } from '../../../src/core/models.js'`

# Groundswell Integration Context
- file: src/agents/prompts.ts
  lines: 157-603
  why: PRP_BLUEPRINT_PROMPT shows how PRP structure is used in LLM prompts
  pattern: The prompt defines the exact structure that PRPDocumentSchema must validate

- file: src/agents/prompts.ts
  lines: 614-685
  why: PRP_BUILDER_PROMPT shows how PRP is consumed during execution
  pattern: References validationGates, successCriteria, implementationSteps

# External Documentation
- url: https://zod.dev/?id=objects
  why: Zod object schema creation documentation
  critical: Use .strict() to prevent extra fields, .passthrough() to allow them

- url: https://zod.dev/?id=primitives
  why: Zod primitive types (string, number, boolean, literal)
  critical: z.literal() for exact value matching, z.union() for multiple types

- url: https://zod.dev/?id=arrays
  why: Zod array validation documentation
  critical: z.array(schema) for typed arrays, can chain .min()/.max() for length constraints

- url: https://zod.dev/?id=unions
  why: Union and discriminated unions documentation
  critical: z.union([schema1, schema2]) for multiple valid types

- url: https://zod.dev/?id=type-inference
  why: Type inference from Zod schemas
  critical: z.infer<typeof Schema> gets TypeScript type from schema
```

### Current Codebase Tree

```bash
src/
├── agents/
│   ├── agent-factory.ts           # Uses prompts with Groundswell
│   └── prompts.ts                 # Contains PRP_BLUEPRINT_PROMPT (lines 157-603)
├── core/
│   └── models.ts                  # CONTAINS ALL INTERFACES AND SCHEMAS
│       ├── StatusEnum (line 78)
│       ├── ValidationGate interface (line 918)
│       ├── ValidationGateSchema (line 985) - ALREADY EXISTS
│       ├── SuccessCriterion interface (line 1018)
│       ├── SuccessCriterionSchema (line 1060) - ALREADY EXISTS
│       ├── PRPDocument interface (line 1114)
│       └── PRPDocumentSchema (line 1213) - ALREADY EXISTS
├── workflows/
│   └── architect-workflow.ts      # Uses BacklogSchema for structured output
tests/
├── unit/
│   └── core/
│       └── models.test.ts         # Existing Zod schema tests
```

### Desired Codebase Tree

```bash
# No structural changes - schemas already exist in src/core/models.ts
# This task is VERIFY/UPDATE rather than CREATE
```

### Known Gotchas of Our Codebase & Library Quirks

```typescript
// CRITICAL: Schemas already exist - this is a verification/update task
// The file src/core/models.ts already contains:
// - ValidationGateSchema at line 985
// - SuccessCriterionSchema at line 1060
// - PRPDocumentSchema at line 1213

// PATTERN: Use z.union([z.literal(1), z.literal(2), ...]) for literal unions
// DO NOT use: z.number().min(1).max(4) - this accepts 1.5, 2.3, etc.
// CORRECT: z.union([z.literal(1), z.literal(2), z.literal(3), z.literal(4)])

// PATTERN: Type annotation is required for proper inference
// CORRECT: export const Schema: z.ZodType<Interface> = z.object({...})
// WITHOUT: export const Schema = z.object({...}) - loses type connection

// GOTCHA: string | null in interface becomes z.string().nullable() in Zod
// DO NOT use: z.union([z.string(), z.null()]) - verbose, use .nullable() instead

// GOTCHA: Readonly properties in interface don't need special Zod handling
// Interface: readonly id: string
// Schema: id: z.string() - no readonly modifier needed

// PATTERN: Array types
// Interface: readonly items: string[]
// Schema: items: z.array(z.string())

// GOTCHA: Zod v3.22.4 doesn't enforce readonly at runtime
// TypeScript interface has readonly for compile-time safety
// Zod schema validates the value, not its mutability

// TEST PATTERN: Use safeParse() for validation tests
// const result = Schema.safeParse(data);
// expect(result.success).toBe(true);
// if (result.success) expect(result.data).toEqual(expected);

// TEST PATTERN: Create reusable fixtures
// const validGate: ValidationGate = { level: 1, description: 'Test', command: 'echo test', manual: false };
```

---

## Implementation Blueprint

### Data Models and Structure

The interfaces already exist in `src/core/models.ts`. This task focuses on verifying/creating matching Zod schemas:

```typescript
// ValidationGate interface (lines 918-962)
interface ValidationGate {
  readonly level: 1 | 2 | 3 | 4;
  readonly description: string;
  readonly command: string | null;
  readonly manual: boolean;
}

// SuccessCriterion interface (lines 1018-1040)
interface SuccessCriterion {
  readonly description: string;
  readonly satisfied: boolean;
}

// PRPDocument interface (lines 1114-1187)
interface PRPDocument {
  readonly taskId: string;
  readonly objective: string;
  readonly context: string;
  readonly implementationSteps: string[];
  readonly validationGates: ValidationGate[];
  readonly successCriteria: SuccessCriterion[];
  readonly references: string[];
}
```

### Implementation Tasks

```yaml
Task 1: VERIFY/UPDATE ValidationGateSchema in src/core/models.ts
  - LOCATION: Lines 985-990 (already exists)
  - VERIFY: Schema uses z.union([z.literal(1), z.literal(2), z.literal(3), z.literal(4)]) for level
  - VERIFY: Schema has z.string() for description
  - VERIFY: Schema has z.string().nullable() for command (NOT z.union([z.string(), z.null()]))
  - VERIFY: Schema has z.boolean() for manual
  - VERIFY: Type annotation is z.ZodType<ValidationGate>
  - EXPORT: Ensure exported as ValidationGateSchema
  - NAMING: Follow existing pattern - camelCase "Schema" suffix

Task 2: VERIFY/UPDATE SuccessCriterionSchema in src/core/models.ts
  - LOCATION: Lines 1060-1063 (already exists)
  - VERIFY: Schema has z.string() for description
  - VERIFY: Schema has z.boolean() for satisfied
  - VERIFY: Type annotation is z.ZodType<SuccessCriterion>
  - EXPORT: Ensure exported as SuccessCriterionSchema
  - PATTERN: Simple object schema, no arrays or nested objects

Task 3: VERIFY/UPDATE PRPDocumentSchema in src/core/models.ts
  - LOCATION: Lines 1213-1223 (already exists)
  - VERIFY: Schema has z.string() for taskId
  - VERIFY: Schema has z.string() for objective
  - VERIFY: Schema has z.string() for context
  - VERIFY: Schema has z.array(z.string()) for implementationSteps
  - VERIFY: Schema has z.array(ValidationGateSchema) for validationGates (reference Task 1)
  - VERIFY: Schema has z.array(SuccessCriterionSchema) for successCriteria (reference Task 2)
  - VERIFY: Schema has z.array(z.string()) for references
  - VERIFY: Type annotation is z.ZodType<PRPDocument>
  - EXPORT: Ensure exported as PRPDocumentSchema
  - PATTERN: Array properties reference previously defined schemas

Task 4: VERIFY exports from src/core/models.ts
  - CHECK: All three schemas are exported (export keyword)
  - CHECK: Schemas appear after their corresponding interfaces
  - CHECK: Export order: interfaces first, then schemas
  - INTEGRATION: Verify no conflicts with existing BacklogSchema, PhaseSchema, etc.

Task 5: CREATE unit tests in tests/unit/core/models.test.ts
  - LOCATION: tests/unit/core/models.test.ts (file already exists)
  - ADD: describe block "ValidationGateSchema" following existing pattern
  - ADD: describe block "SuccessCriterionSchema" following existing pattern
  - ADD: describe block "PRPDocumentSchema" following existing pattern
  - FIXTURE: Create validGate, validCriterion, validPRP fixtures
  - TEST: Happy path - valid data passes validation
  - TEST: Invalid level (5, 0, '1') fails validation for ValidationGate
  - TEST: Invalid command type (number, object) fails validation
  - TEST: Invalid satisfied type (string, number) fails validation
  - TEST: Missing required properties fail validation
  - COVERAGE: All three schemas have tests

Task 6: RUN validation commands
  - EXECUTE: npm test to verify all tests pass
  - EXECUTE: npm run check to verify TypeScript compilation
  - EXECUTE: npm run lint to verify ESLint passes
  - FIX: Any errors found during validation
```

### Implementation Patterns & Key Details

```typescript
// ============================================
// PATTERN 1: Literal Union for Level Field
// ============================================
// Level must be exactly 1, 2, 3, or 4 (not 1.5, not 5, not "1")
level: z.union([z.literal(1), z.literal(2), z.literal(3), z.literal(4)]);

// GOTCHA: Do NOT use z.number().min(1).max(4)
// This would accept 1.5, 2.3, and other non-integer values

// ============================================
// PATTERN 2: Nullable String for Command
// ============================================
// Command can be a string OR null (not undefined)
command: z.string().nullable();

// GOTCHA: Do NOT use z.union([z.string(), z.null()])
// While it works, .nullable() is more idiomatic

// ============================================
// PATTERN 3: Array of Other Schemas
// ============================================
// validationGates is an array of ValidationGate objects
validationGates: z.array(ValidationGateSchema);

// PATTERN: Import the schema, not the interface
// CORRECT: z.array(ValidationGateSchema)
// WRONG: z.array(z.object({...})) - duplicates schema definition

// ============================================
// PATTERN 4: Type Annotation
// ============================================
// Always use z.ZodType<InterfaceName> annotation
export const ValidationGateSchema: z.ZodType<ValidationGate> = z.object({
  level: z.union([z.literal(1), z.literal(2), z.literal(3), z.literal(4)]),
  description: z.string(),
  command: z.string().nullable(),
  manual: z.boolean(),
});

// GOTCHA: Without type annotation, TypeScript inference may be incorrect
// ESPECIALLY for union types with z.literal()

// ============================================
// PATTERN 5: Test Fixture Creation
// ============================================
// Create reusable valid fixtures for testing
const validGate: ValidationGate = {
  level: 1,
  description: 'Syntax & Style validation',
  command: 'npm run lint',
  manual: false,
};

const validCriterion: SuccessCriterion = {
  description: 'All tests pass',
  satisfied: false,
};

const validPRP: PRPDocument = {
  taskId: 'P2.M2.T2.S1',
  objective: 'Create Zod schemas for PRP structure',
  context: '# All Needed Context\\n\\n...',
  implementationSteps: [
    'Create ValidationGateSchema',
    'Create SuccessCriterionSchema',
  ],
  validationGates: [validGate],
  successCriteria: [validCriterion],
  references: ['https://zod.dev', 'src/core/models.ts'],
};

// ============================================
// PATTERN 6: Test Structure
// ============================================
describe('ValidationGateSchema', () => {
  const validGate: ValidationGate = {
    level: 1,
    description: 'Test',
    command: 'test',
    manual: false,
  };

  it('should validate a valid gate', () => {
    const result = ValidationGateSchema.safeParse(validGate);
    expect(result.success).toBe(true);
    if (result.success) {
      expect(result.data).toEqual(validGate);
    }
  });

  it('should reject invalid level', () => {
    const invalid = { ...validGate, level: 5 };
    const result = ValidationGateSchema.safeParse(invalid);
    expect(result.success).toBe(false);
  });

  it('should reject non-integer level', () => {
    const invalid = { ...validGate, level: 1.5 };
    const result = ValidationGateSchema.safeParse(invalid);
    expect(result.success).toBe(false);
  });

  it('should accept null command', () => {
    const withNull = { ...validGate, command: null };
    const result = ValidationGateSchema.safeParse(withNull);
    expect(result.success).toBe(true);
  });
});
```

### Integration Points

```yaml
FILE_MODIFICATION:
  - file: src/core/models.ts
    existing_interfaces:
      - ValidationGate (line 918)
      - SuccessCriterion (line 1018)
      - PRPDocument (line 1114)
    existing_schemas:
      - ValidationGateSchema (line 985) - VERIFY/UPDATE
      - SuccessCriterionSchema (line 1060) - VERIFY/UPDATE
      - PRPDocumentSchema (line 1213) - VERIFY/UPDATE

TEST_CREATION:
  - file: tests/unit/core/models.test.ts
    pattern: Add new describe blocks following existing schema test structure
    fixtures: Create validGate, validCriterion, validPRP fixtures

EXPORT_VERIFICATION:
  - verify: All three schemas exported from src/core/models.ts
  - check: No naming conflicts with existing exports (BacklogSchema, PhaseSchema, etc.)

GROUNDSWELL_INTEGRATION:
  - future: P2.M2.T2.S2 will use PRPDocumentSchema with responseFormat
  - pattern: responseFormat: PRPDocumentSchema (similar to BacklogSchema in architect-workflow.ts)
```

---

## Validation Loop

### Level 1: Syntax & Style (Immediate Feedback)

```bash
# Run after modifying src/core/models.ts
npm run check          # TypeScript compilation check
npm run lint           # ESLint validation
npm run format         # Prettier formatting

# Expected: Zero errors. If errors exist, READ output and fix before proceeding.
```

### Level 2: Unit Tests (Component Validation)

```bash
# Test all models including new schemas
npm test -- tests/unit/core/models.test.ts

# Run with coverage
npm run test:coverage

# Expected: All tests pass. If failing, debug root cause and fix implementation.
```

### Level 3: Integration Testing (System Validation)

```bash
# Verify schemas can be imported and used
node -e "
import { ValidationGateSchema, SuccessCriterionSchema, PRPDocumentSchema } from './src/core/models.js';
console.log('Schemas imported successfully');
console.log('ValidationGateSchema:', typeof ValidationGateSchema);
console.log('SuccessCriterionSchema:', typeof SuccessCriterionSchema);
console.log('PRPDocumentSchema:', typeof PRPDocumentSchema);
"

# Verify type inference works
node -e "
import { PRPDocumentSchema, type PRPDocument } from './src/core/models.js';
import type { infer } from 'zod';
type InferredPRP = infer<typeof PRPDocumentSchema>;
// Type should match PRPDocument interface
console.log('Type inference verified');
"

# Expected: No import errors, types match interfaces
```

### Level 4: Schema Validation Testing

```bash
# Manual verification of schema behavior
node -e "
import { ValidationGateSchema, SuccessCriterionSchema, PRPDocumentSchema } from './src/core/models.js';

// Test 1: Valid ValidationGate
const validGate = {
  level: 1,
  description: 'Test gate',
  command: 'echo test',
  manual: false,
};
console.log('Valid gate:', ValidationGateSchema.safeParse(validGate).success);

// Test 2: Invalid level
const invalidLevel = { ...validGate, level: 5 };
console.log('Invalid level should fail:', !ValidationGateSchema.safeParse(invalidLevel).success);

// Test 3: Null command
const nullCommand = { ...validGate, command: null };
console.log('Null command should pass:', ValidationGateSchema.safeParse(nullCommand).success);

// Test 4: Valid PRPDocument
const validPRP = {
  taskId: 'P2.M2.T2.S1',
  objective: 'Test objective',
  context: '# Context',
  implementationSteps: ['Step 1'],
  validationGates: [validGate],
  successCriteria: [{ description: 'Test', satisfied: false }],
  references: ['https://test.com'],
};
console.log('Valid PRP:', PRPDocumentSchema.safeParse(validPRP).success);

console.log('All manual verifications complete');
"

# Expected: All valid tests return true, all invalid tests return false
```

---

## Final Validation Checklist

### Technical Validation

- [ ] All 4 validation levels completed successfully
- [ ] All tests pass: `npm test`
- [ ] No linting errors: `npm run lint`
- [ ] No type errors: `npm run check`
- [ ] No formatting issues: `npm run format -- --check`

### Feature Validation

- [ ] `ValidationGateSchema` validates level as literal 1|2|3|4 (not number)
- [ ] `ValidationGateSchema` validates command as string|null (nullable)
- [ ] `SuccessCriterionSchema` validates description as string, satisfied as boolean
- [ ] `PRPDocumentSchema` validates all 7 properties with correct types
- [ ] All schemas export from `src/core/models.ts`
- [ ] Type annotations `z.ZodType<InterfaceName>` present on all schemas
- [ ] Unit tests cover happy paths, edge cases, and error scenarios

### Code Quality Validation

- [ ] Follows existing Zod schema patterns in `src/core/models.ts`
- [ ] No new files created - modifications only to existing file
- [ ] Schemas placed after their corresponding interfaces
- [ ] No naming conflicts with existing exports
- [ ] Test structure follows existing pattern in `tests/unit/core/models.test.ts`

### Documentation & Deployment

- [ ] No new environment variables needed
- [ ] No configuration changes needed
- [ ] Changes are additive - no breaking changes to existing exports
- [ ] Ready for P2.M2.T2.S2 (Create PRP generation prompt) to use PRPDocumentSchema

---

## Anti-Patterns to Avoid

- [ ] Don't use `z.number().min(1).max(4)` for level field - must use `z.union([z.literal(1), ...])`
- [ ] Don't use `z.union([z.string(), z.null()])` for nullable - use `.nullable()` instead
- [ ] Don't forget `z.ZodType<InterfaceName>` type annotation on schemas
- [ ] Don't duplicate array schema definitions - reference the schema: `z.array(ValidationGateSchema)`
- [ ] Don't create new files - all work in existing `src/core/models.ts`
- [ ] Don't skip type checking - run `npm run check` after changes
- [ ] Don't skip tests - every schema needs test coverage
- [ ] Don't use `z.any()` or `z.unknown()` - use specific types
- [ ] Don't forget to export schemas with `export` keyword
- [ ] Don't place schemas before their interfaces - interfaces come first

---

## Success Metrics

**Confidence Score**: 10/10 for one-pass implementation success

**Validation**: The schemas already exist in the codebase. This task is primarily verification that existing schemas match their interfaces correctly, with updates if needed. All context, file locations, line numbers, and patterns are provided.

**Confidence Rationale**:

1. Schemas already exist at known line numbers
2. Interface definitions are at known line numbers
3. Existing test patterns are available in `tests/unit/core/models.test.ts`
4. All Zod patterns are documented with examples from the codebase
5. External Zod documentation URLs provided for reference
6. No new files or structural changes needed
7. Clear anti-patterns to avoid

**Next Steps After Completion**:

- P2.M2.T2.S2 (Create PRP generation prompt) will use `PRPDocumentSchema` with Groundswell's `responseFormat`
- P3.M3.T1.S2 (Create PRP Executor) will consume validated PRP documents
- Integration testing will verify end-to-end PRP generation and validation
